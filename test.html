<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Test</title>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./test.css">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>

<body>

    <!-- content-toggle content-toggle-hide -->
    <div class="content-toggle content-toggle-hide content-trans" id="id-toggle">
        <i class="fa fa-chevron-left"></i>
        <span>Events</span>
    </div>

    <!-- content-nav content-nav-open -->
    <nav class="content-nav content-trans" id="id-nav">
        <div id="id-head">
            <a id="id-ping" href="javascript:void(0)">
                <i class="fa fa-thumb-tack"></i>
            </a>
        </div>
        <div id="id-content"></div>
        <div id="id-foot">
            <div id="id-more-div">
                <a id="id-more-a" href="javascript:void(0)">More...</a>
            </div>
            <div id="id-loading-label">Loading...</div>
        </div>
    </nav>

    <h1 style="margin: 2000px"></h1>


    <script>

        (() => {

            // token = null;
            // url = "https://api.github.com/users/yoruko-km/events?page=";
            token = null;
            // url = "https://api.github.com/users/Aoi-hosizora/events?page=";
            url = "https://api.github.com/repos/angular/angular/events?page=";

            page = 1;
            isClose = false;
            firstFlag = true;
                
            // 容器
            var ulTag = document.createElement('ul');
            ulTag.id = "id-ul";
            ulTag.onload = () => this.parent.removeChild(ulTag);
            $('#id-content').append(ulTag);

            // Label
            showLoading(true);

            // 展开
            closeNav(isClose);

            // 异步获取
            ajax(url, page, token, (events) => {
                addEvents(events);
                showLoading(false);
            }, () => {
                showLoading(false, true);
            });
        })();

        // TODO
        $('#id-toggle').click(() => {
            isClose = false;
            closeNav(isClose);
        });

        // TODO
        $('#id-ping').click(() => {
            isClose = true;
            closeNav(isClose);
        });
        /**
         * More... 处理
         */
        $('#id-more-a').click(() => {
            showLoading(true);
            
            ajax(url, ++page, token, (events) => {
                addEvents(events);
                showLoading(false, false);
            }, () => {
                showLoading(false, true);
            });
        });

        /**
         * 显示 Loading / More
         */ 
        function showLoading(isLoading, isError=false) {
            if (isLoading) {
                $('#id-more-div').hide();
                $('#id-loading-label').show();
            }
            else {
                $('#id-more-a').text(
                    isError ? "Something error happened, try again..." : "More..."
                )
                $('#id-loading-label').hide();
                $('#id-more-div').show();
            }
        }

        /**
         * 关闭 右侧栏
         */
        function closeNav(closeFlag) {
            var nav = $('.content-nav').first();
            var toggle = $('.content-toggle').first();
            if (closeFlag) {
                nav.removeClass('content-nav-open');
                toggle.removeClass('content-toggle-hide');
            }
            else {
                toggle.addClass('content-toggle-hide');
                nav.addClass('content-nav-open');
            }
        }
        
        /**
         * 异步获取数据 回调
         */ 
        function ajax(url, page, token, cb, err) {
            $.ajax({
                type: 'GET',
                url: url + page,
                beforeSend: (xhr) => {
                    if (token)
                        xhr.setRequestHeader("Authorization", "Token " + token);
                },
                success: (data) => {
                    cb(data);
                },
                error: (jqXHR, textStatus, errorThrown) => {
                    // console.log(textStatus);
                    err();
                }
            });
        }

        /**
         * !!! DOM 操作 
         */
        function addEvents(events) {
            if (!events) return;
            console.log(events);
            events.forEach(event => {
                var ret = parseApiJson(event);
                console.log(ret);

                var commitsTag = '', issueTag = '';
                if (ret.commits) {
                    ret.commits.forEach((commit) => {
                        commitsTag += `
                            <div class="commit-div">
                                <a href="${commit['url']}" target="_blank" class="commit-sha">${commit['sha'].substring(0, 6)}</a>
                                <span class="commit-title"> ${commit['commit']}</span>
                            </div>
                        `;
                    })
                }
                if (ret.issue) {
                    // if (ret.issue.length > 50) ret.issue = ret.issue.substring(0, 50) + ' ...'
                    ret.issue = ret.issue.replace("<code>", "").replace("</code>", "").replace("<pre>", "").replace("</pre>", "");
                    issueTag = `<div class="content-issue">${ret.issue}</div>`;
                }

                if (ret.title)
                    ret.title = ret.title.replace(ret.title[0], ret.title[0].toUpperCase())
                
                var mt = ret.title.split(' ');
                var mr = mt[mt.length - 1];
                mt = mt.slice(0, mt.length - 1).join(' ');

                var titleSpanTag = `<span class="content-title">${mt} </span>`;
                
                if (ret.type == 'ForkEvent') {
                    // Forked angular/angular to coulonxyz/angular
                    mt = mt.split(' ');
                    var forker = mt[1];
                    titleSpanTag = `<span class="content-title">${mt[0]} <a href="${ret.forker_url}" target="_blank">${forker}</a> ${mt.slice(2, mt.length).join(' ')}</span>`;
                }
                else if (ret.type == "IssueCommentEvent") {
                    // Created comment on issue #32258 "yarn setup not working in aio" in angular/angular
                    mt = mt.split(' ');
                    var issueId = mt[4];
                    titleSpanTag = `<span class="content-title">${mt.splice(0, 4).join(' ')} <a href="${ret.comment_url}" target="_blank">${issueId}</a> ${mt.slice(1, mt.length).join(' ')}</span>`;
                }
                else if (ret.type == "IssuesEvent") {
                    // Opened issue #32264 in angular/angular
                    mt = mt.split(' ');
                    var issueId = mt[2];
                    titleSpanTag = `<span class="content-title">${mt.splice(0, 2).join(' ')} <a href="${ret.comment_url}" target="_blank">${issueId}</a> ${mt.slice(1, mt.length).join(' ')}</span>`;
                }
                else if (ret.type == "PullRequestEvent") {
                    // Opened pull request #32267 "docs: fixed animations reference links to api" at angular/angular
                    mt = mt.split(' ');
                    var pullReqId = mt[3];
                    titleSpanTag = `<span class="content-title">${mt.splice(0, 3).join(' ')} <a href="${ret.pullreq_url}" target="_blank">${pullReqId}</a> ${mt.slice(1, mt.length).join(' ')}</span>`;
                }

                // 内容
                $('#id-ul').append(`
                    ${firstFlag == true ? '' : '<hr />'}
                    <li>
                        <div class="avator-div">
                            <img src="${ret.avatar_url}" alt="user-avatar" class="avator-icon"/>
                            <span class="avator-link"><a href="${ret.user_url}" target="_blank">${ret.user}</a></span>
                        </div>
                        ${titleSpanTag}
                        <a href="${ret.url}" target="_blank" class="content-repo">${mr}</a>
                        ${commitsTag} ${issueTag} 
                    </li>
                `);

                firstFlag = false;
            });
        }
    
        /**
         * 解析返回的 API 结果
         */
        function parseApiJson(event) {
            
            /*
                PushEvent
                CreateEvent (repo)
                CreateEvent (branch)
                WatchEvent
                MemberEvent
                IssuesEvent
                IssueCommentEvent
                ForkEvent
                PullRequestEvent
            */

            let type = event['type'];
            let actor = event['actor']['login'];
            let repo = event['repo']['name'];
            let payload = event['payload'];

            let url = "https://" + event['repo']['url']
                .replace("https://api.", "").replace("http://api.", "")
                .replace("repos/", "");
            let user_url = "https://" + event['actor']['url']
                .replace("https://api.", "").replace("http://api.", "")
                .replace("users/", "");
            let avatar_url = event['actor']['avatar_url'];

            let comment_url = "";
            let forker_url = "";
            let pullreq_url = "";

            let title = '';
            let commits = [];
            let issue = '';

            switch (type) {
                case 'PushEvent': 
                    title = `pushed ${payload['size']} 
                        ${(payload['size'] == 1) ? ' commit to ' : ' commits to '} 
                        ${payload['ref'].split('/')[2]} at ${repo}`;
                    payload['commits'].forEach(commit => {
                        commits.push({
                            'sha': commit['sha'],
                            'commit': commit['message'],
                            'url': "https://" + commit['url']
                                .replace("https://api.", "").replace("http://api.", "")
                                .replace("commits/", "commit/").replace("repos/", "")
                        })
                    });
                break;
                case 'WatchEvent': 
                    title = `starred repository ${repo}`;
                break;
                case 'CreateEvent': 
                    if (payload['ref_type'] == 'branch')
                        title = `created branch ${payload['ref']} at ${repo}`;
                    else if (payload['ref_type'] == 'repository')
                        title = `created a ${event['public'] ? 'public' : 'private'} repository ${repo}`;
                break;
                case 'IssuesEvent': 
                    title = `${payload['action']} issue #${payload['issue']['number']} in ${repo}`;
                    issue = `${payload['issue']['title']}: ${payload['issue']['body']}`;
                    comment_url = payload['issue']['html_url'];
                break;
                case 'IssueCommentEvent':
                    title = `created comment on issue #${payload['issue']['number']} "${payload['issue']['title']}" in ${repo}`;
                    issue = payload['comment']['body'];
                    comment_url = payload['comment']['html_url'];
                break;
                case 'ForkEvent': 
                    title = `forked ${repo} to ${payload['forkee']['full_name']}`;
                    forker_url = url;
                    url = payload['forkee']['html_url'];
                break;
                case 'PullRequestEvent':
                    title = `${payload['action']} pull request #${payload['number']} "${payload['pull_request']['title']}" at ${repo}`;
                    pullreq_url = payload['pull_request']['html_url'];
                break;
                case 'MemberEvent': 
                    title = `${payload['action']} member ${payload['member']['login']} to ${repo}`; 
                break;
                default:
                    return {
                        type: type,
                        title: "Unknown Event",
                        url: "https://github.com",
                        user_url: user_url,
                    }
            }
            
            return {
                type: type,
                title: title,
                url: url,
                comment_url: comment_url,
                forker_url: forker_url,
                pullreq_url: pullreq_url,
                user: actor,
                user_url: user_url,
                avatar_url: avatar_url,
                commits: commits,
                issue: issue
            }
        }
    </script>
</body>

</html>